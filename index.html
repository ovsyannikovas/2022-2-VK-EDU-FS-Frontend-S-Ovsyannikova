<!DOCTYPE html>
<html>
<head lang="en">
    <link rel="stylesheet" href="index.css" type="text/css"/>
    <script type="text/javascript" src="index.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta charset="UTF-8">
    <title>MyChat</title>
</head>
<body>
<header class="site-header">
    <div class="arrow">
        <a href="#" class="logo">
            <i class="material-icons icon">arrow_back</i>
        </a>
    </div>
    <a href="#">
        <div class="user-info">
            <i class="material-icons avatar">account_circle</i>
            <div class="user-text">
                <p class="name">Дженнифер</p>
                <p class="time">была 2 часа назад</p>
            </div>
        </div>
    </a>
    <div class="buttons">
        <a href="#">
            <i class="material-icons icon">search</i>
        </a>
        <a href="#">
            <i class="material-icons icon">menu</i>
        </a>
    </div>
</header>
<form class="form" action="/">
    <div class="message-list">
    </div>
    <div class="input">
        <input class="form-input" name="message-text" placeholder="Сообщение" type="text">
        <a href="#">
            <i class="material-icons icon">attachment</i>
        </a>
    </div>
</form>
<script>
    chat = [
        {
            "name": "Дженнифер",
            "time": "10:40",
            "content": "Я тут кое-что нарисовала. Напиши, как освободишься."
        },
        {
            "name": "Мое имя",
            "time": "10:50",
            "content": "Хорошо. Освобожусь где-то через час."
        },
        {
            "name": "Дженнифер",
            "time": "10:55",
            "content": "Жду!"
        },
    ]

    const userName = "Мое имя"
    const form = document.querySelector('form')
    const input = document.querySelector('.form-input')
    const message_list = document.querySelector('.message-list')
    message_list.scrollTop = message_list.scrollHeight

    if (!localStorage.getItem("chat")) {
        localStorage.setItem("chat", JSON.stringify(chat))
    }

    const chatHistory = JSON.parse(localStorage.getItem("chat"))
    restoreHistory(chatHistory)

    function restoreHistory(messages) {
        messages.forEach(function (message) {
            let class_name = message.name === userName ? "my-message" : ""
            const templateDiv =
                "<div class='message-bubble " + class_name + "'>" + "<div class='message'>" +
                "<p>" + message.content + "</p>" + "<time>" +
                message.time + "</time>" + "</div>" + "</div>"
            message_list.innerHTML += templateDiv
        })
    }

    form.addEventListener('submit', this.handleSubmit.bind(this))
    form.addEventListener('keypress', this.handleKeyPress.bind(this))

    function handleSubmit(event) {
        event.preventDefault();
        if (input.value === "")
            return

        const message = {
            name: userName,
            time: new Date().toLocaleTimeString().slice(0, -3),
            content: input.value,
        }
        chatHistory.push(message)
        document.querySelector('.form-input').value = ""

        localStorage.setItem("chat", JSON.stringify(chatHistory))
        let localData = JSON.parse(localStorage.getItem("chat"))
        let last = localData.length - 1
        const templateDiv =
            "<div class='message-bubble my-message'>" + "<div class='message'>" +
            "<p>" + localData[last].content + "</p>" + "<time>" +
            localData[last].time + "</time>" + "</div>" + "</div>"
        message_list.innerHTML += templateDiv
        message_list.scrollTop = message_list.scrollHeight
    }

    function handleKeyPress(event) {
        if (event.keyCode === 13) {
            form.dispatchEvent(new Event('submit'));
        }
    }

</script>
<script type="text/javascript" src="bundle.js"></script></body>
</html>
